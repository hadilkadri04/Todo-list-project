// Jenkinsfile â€” ISG Sousse DevOps Project
// Unified for all 3 pipelines: PR â†’ dev, push â†’ dev, tag vX.Y.Z
pipeline {
    agent any

    environment {
        BUILD_TAG = "build-${BUILD_NUMBER}"
        BACKEND_PORT = "8081"
        FRONTEND_PORT = "8888"
    }

    stages {
        stage('Start') {
            steps {
                script {
                    if (env.CHANGE_ID) {
                        echo "ðŸš€ Pipeline 1: Build & Smoke sur PR #${env.CHANGE_ID}"
                    } else if (env.TAG_NAME) {
                        echo "ðŸ“¦ Pipeline 3: Build versionnÃ© (tag ${env.TAG_NAME})"
                    } else {
                        echo "âœ… Pipeline 2: Build complet sur push (branche ${env.BRANCH_NAME ?: 'unknown'})"
                    }
                }
            }
        }

        stage('1. Checkout') {
            steps {
                checkout scm
                script {
                    def commit = bat(
                        returnStdout: true,
                        script: 'git rev-parse --short HEAD 2>nul || echo UNKNOWN'
                    ).trim()
                    echo "âœ… Checked out commit: ${commit}"
                }
            }
        }

        stage('2. Setup') {
            steps {
                bat '''
                    @echo off
                    echo ðŸ”§ Cleaning old containers...
                    for /f "tokens=*" %%i in ('docker ps -q --filter name=todolist- 2^>nul') do (
                        docker stop %%i 2>nul && docker rm %%i 2>nul
                    )
                    docker volume prune -f 2>nul
                '''
            }
        }

        stage('3. Build') {
            parallel {
                stage('Backend') {
                    steps {
                        echo "ðŸ—ï¸ Building backend (PHP + MySQL)..."
                        bat "docker build -t todolist-backend:${env.BUILD_TAG} ./backend"
                    }
                }
                stage('Frontend') {
                    steps {
                        echo "ðŸ—ï¸ Building frontend (Nginx)..."
                        bat "docker build -t todolist-frontend:${env.BUILD_TAG} ./frontend"
                    }
                }
            }
        }

        stage('4. Run (Docker Compose)') {
            steps {
                echo "ðŸš€ Starting services: db + backend + frontend..."
                bat "docker-compose up -d --build"
                echo "â³ Waiting 30s for MySQL + Apache to initialize..."
                bat "timeout /t 30 /nobreak >nul"
                echo "âœ… All services running"
            }
        }

        stage('5. Smoke Test') {
            steps {
                script {
                    echo "ðŸ§ª Running smoke tests..."

                    // Test 1: Backend API (with retry)
                    def backendOk = false
                    for (int i = 0; i < 6 && !backendOk; i++) {
                        def status = bat(
                            returnStatus: true,
                            script: '''
                                @powershell -Command "try {
                                    $r = irm http://localhost:8081/api.php -UseBasicParsing -ErrorAction Stop
                                    exit ($r.Count -ge 0) ? 0 : 1
                                } catch { exit 1 }"
                            '''
                        )
                        backendOk = (status == 0)
                        if (!backendOk && i < 5) {
                            echo "â³ Backend not ready (attempt ${i+1}/6)..."
                            sleep time: 5, unit: 'SECONDS'
                        }
                    }

                    // Test 2: Frontend UI
                    def frontendOk = bat(
                        returnStatus: true,
                        script: '''
                            @powershell -Command "try {
                                $r = (Invoke-WebRequest http://localhost:8888 -UseBasicParsing).StatusCode
                                exit ($r -eq 200) ? 0 : 1
                            } catch { exit 1 }"
                        '''
                    ) == 0

                    // Test 3: CRUD (POST)
                    def crudOk = false
                    if (backendOk) {
                        def status = bat(
                            returnStatus: true,
                            script: '''
                                @powershell -Command "try {
                                    $body = @{title='[CI] Smoke Test'} | ConvertTo-Json
                                    $resp = irm http://localhost:8081/api.php -Method Post -Body $body -ContentType 'application/json' -UseBasicParsing
                                    exit ($resp.status -eq 'created') ? 0 : 1
                                } catch { exit 1 }"
                            '''
                        )
                        crudOk = (status == 0)
                    }

                    // Report
                    echo "âœ… Backend: ${backendOk ? 'PASSED' : 'FAILED'}"
                    echo "âœ… Frontend: ${frontendOk ? 'PASSED' : 'FAILED'}"
                    echo "âœ… CRUD: ${crudOk ? 'PASSED' : 'FAILED'}"

                    if (!(backendOk && frontendOk && crudOk)) {
                        currentBuild.result = 'FAILURE'
                        error "âŒ Smoke test FAILED"
                    }
                    echo "ðŸŽ‰ All smoke tests PASSED"
                }
            }
        }

        stage('6. Archive Artifacts') {
            steps {
                bat '''
                    @echo off
                    mkdir reports 2>nul
                    docker logs todolist-db > reports/db.log 2>nul
                    docker logs todolist-backend > reports/backend.log 2>nul
                    docker logs todolist-frontend > reports/frontend.log 2>nul
                    echo Build: %BUILD_NUMBER% > reports/build-info.txt
                    echo Branch/Tag: %BRANCH_NAME% / %TAG_NAME% >> reports/build-info.txt
                    echo Smoke test: PASSED > reports/smoke-result.txt
                    echo Workspace: %cd% >> reports/build-info.txt
                '''
                archiveArtifacts artifacts: 'reports/**', fingerprint: true
                echo "ðŸ“¦ Artifacts archived: ${BUILD_URL}artifact/"
            }
        }
    }

    post {
        always {
            echo "ðŸ§¹ Cleanup: stopping containers..."
            bat '''
                @echo off
                docker-compose down -v --remove-orphans 2>nul
                echo "âœ… Pipeline finished (${currentBuild.result ?: 'SUCCESS'})"
            '''
        }
    }
}