// Jenkinsfile â€” Windows-compatible, aligned with your dev setup
pipeline {
    agent any

    environment {
        BUILD_TAG = "build-${env.BUILD_NUMBER}"
        BACKEND_PORT = "8081"
        FRONTEND_PORT = "8888"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                echo "âœ… Code checked out from branch: ${env.BRANCH_NAME}"
            }
        }

        stage('Setup') {
            steps {
                @echo off
                echo Stopping and removing old containers...
                docker ps -q --filter name=todolist- | findstr . >nul && (
                for /f "tokens=*" %%i in ('docker ps -q --filter name=todolist-') do docker stop %%i 2>nul && docker rm %%i 2>nul
                ) || echo No old containers found.

                echo Pruning dangling volumes...
                docker volume prune -f 2>nul
            }
        }

        stage('Build') {
            parallel {
                stage('Build Backend') {
                    steps {
                        echo "ðŸ—ï¸ Building backend (PHP + MySQL)..."
                        bat "docker build -t todolist-backend:${env.BUILD_TAG} ./backend"
                    }
                }
                stage('Build Frontend') {
                    steps {
                        echo "ðŸ—ï¸ Building frontend (Nginx)..."
                        bat "docker build -t todolist-frontend:${env.BUILD_TAG} ./frontend"
                    }
                }
            }
        }

        stage('Run (Docker Compose)') {
            steps {
                echo "ðŸš€ Starting services with docker-compose (DB + backend + frontend)..."
                bat "docker-compose up -d --build"
                bat "timeout /t 20 /nobreak >nul"  // Wait 20s for MySQL init
                echo "âœ… Containers running"
            }
        }

        stage('Smoke Test') {
            steps {
                script {
                    echo "ðŸ§ª Running smoke tests..."

                    // Test 1: Backend API reachable?
                    def backendUp = bat(
                        script: '''
                            @powershell -Command "try { $r = Invoke-RestMethod http://localhost:8081/api.php -UseBasicParsing; if ($r.Count -ge 0) { exit 0 } else { exit 1 } } catch { exit 1 }"
                        ''',
                        returnStatus: true
                    ) == 0

                    // Test 2: Frontend UI reachable?
                    def frontendUp = bat(
                        script: '''
                            @powershell -Command "try { $r = (Invoke-WebRequest http://localhost:8888).StatusCode; if ($r -eq 200) { exit 0 } else { exit 1 } } catch { exit 1 }"
                        ''',
                        returnStatus: true
                    ) == 0

                    // Test 3: Can add a task? (CRUD smoke)
                    def taskAdded = bat(
                        script: '''
                            @powershell -Command "try {
                                $body = @{title='[CI] Smoke Test'} | ConvertTo-Json
                                $resp = irm -Uri http://localhost:8081/api.php -Method Post -Body $body -ContentType 'application/json' -UseBasicParsing
                                if ($resp.status -eq 'created') { exit 0 } else { exit 1 }
                            } catch { exit 1 }"
                        ''',
                        returnStatus: true
                    ) == 0

                    echo "Backend: ${backendUp ? 'âœ…' : 'âŒ'} | Frontend: ${frontendUp ? 'âœ…' : 'âŒ'} | CRUD: ${taskAdded ? 'âœ…' : 'âŒ'}"

                    if (!(backendUp && frontendUp && taskAdded)) {
                        error "âŒ Smoke test failed"
                    }
                    echo "âœ… All smoke tests passed"
                }
            }
        }

        stage('Archive Artifacts') {
            steps {
                bat '''
                    @echo off
                    mkdir reports 2>nul
                    docker logs todolist-db > reports/db.log 2>nul
                    docker logs todolist-backend > reports/backend.log 2>nul
                    docker logs todolist-frontend > reports/frontend.log 2>nul
                    echo Build: %BUILD_NUMBER% (%DATE% %TIME%) > reports/build-info.txt
                    echo "Smoke test passed" > reports/smoke-result.txt
                '''
                archiveArtifacts artifacts: 'reports/**', fingerprint: true
                echo "ðŸ“¦ Artifacts archived"
            }
        }
    }

    post {
        always {
            echo "ðŸ§¹ Cleanup: stopping containers..."
            bat '''
                @echo off
                docker-compose down -v --remove-orphans 2>nul
                echo "âœ… Pipeline finished"
            '''
        }
    }
}